version: '3.8'

services:
  relay:
    build: .
    ports:
      - "8000:8000"
    environment:
      # 上游地址
      - UPSTREAM_OPENAI_BASE_URL=${UPSTREAM_OPENAI_BASE_URL:-https://api.openai.com}
      - UPSTREAM_GEMINI_BASE_URL=${UPSTREAM_GEMINI_BASE_URL:-https://generativelanguage.googleapis.com}
      - UPSTREAM_CLAUDE_BASE_URL=${UPSTREAM_CLAUDE_BASE_URL:-https://api.anthropic.com}
      
      # 抗截断配置
      - ANTI_TRUNCATION_ENABLED_DEFAULT=${ANTI_TRUNCATION_ENABLED_DEFAULT:-false}
      - ANTI_TRUNCATION_MAX_ATTEMPTS=${ANTI_TRUNCATION_MAX_ATTEMPTS:-3}
      - ANTI_TRUNCATION_DONE_MARKER=${ANTI_TRUNCATION_DONE_MARKER:-[done]}
      - ANTI_TRUNCATION_MODEL_PREFIX=${ANTI_TRUNCATION_MODEL_PREFIX:-流式抗截断/}
      
      # 透明代理配置
      - TRUST_PROXY_HEADERS=${TRUST_PROXY_HEADERS:-true}
      - TRUSTED_PROXY_CIDRS=${TRUSTED_PROXY_CIDRS:-127.0.0.0/8,::1/128,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16}
      
      # HTTP 行为配置
      - UPSTREAM_TIMEOUT_SECONDS=${UPSTREAM_TIMEOUT_SECONDS:-60}
      - UPSTREAM_CONNECT_TIMEOUT_SECONDS=${UPSTREAM_CONNECT_TIMEOUT_SECONDS:-10}
      - MAX_BODY_SIZE_MB=${MAX_BODY_SIZE_MB:-50}
    
    restart: unless-stopped
    
    # 可选：挂载 .env 文件
    # env_file:
    #   - .env
